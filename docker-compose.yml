# FGN Savings Bond Application - Docker Compose
# React + FastAPI architecture with SQLite database
#
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose ps             # Check service status
#   docker-compose logs -f        # View all logs
#   docker-compose down           # Stop all services
#
# Access Points (via Nginx):
#   - User Form:    http://localhost        (port 80)
#   - Admin:        http://localhost/admin
#   - API:          http://localhost/api
#
# Direct Access (bypass Nginx):
#   - Frontend:     http://localhost:3000
#   - Backend API:  http://localhost:8000

services:
  # ==========================================================================
  # Nginx Reverse Proxy
  # Entry point for all HTTP traffic, routes to frontend and backend
  # ==========================================================================
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - backend
    networks:
      - fgn_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # React Frontend (Production)
  # User-facing bond subscription form and admin dashboard
  # ==========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - fgn_network
    restart: unless-stopped

  # ==========================================================================
  # Frontend Test Runner
  # Run with: docker-compose --profile test run --rm frontend-test
  # ==========================================================================
  frontend-test:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: test
    profiles:
      - test
    networks:
      - fgn_network

  # ==========================================================================
  # FastAPI Backend
  # REST API for form submission, PDF generation, and admin features
  # ==========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    env_file:
      - ./backend/.env
    environment:
      # Override password hash ($ must be escaped as $$ in docker-compose.yml)
      - ADMIN_PASSWORD_HASH=$$2b$$12$$TdQ.V0Ryh1Va2Bxzkr6JfuSSSTvxQsGOu7sOXaLwU8KJBx9apGHTK
    volumes:
      - ./backend/data:/app/data          # SQLite database
      - ./backend/logs:/app/logs          # Application logs
      - ./backend/uploads:/app/uploads    # Payment evidence uploads
    networks:
      - fgn_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

# ==========================================================================
# Networks
# ==========================================================================
networks:
  fgn_network:
    driver: bridge
