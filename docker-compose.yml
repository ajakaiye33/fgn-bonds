# FGN Savings Bond Application - Docker Compose
# Development configuration with health checks and resource limits
#
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose ps             # Check service status
#   docker-compose logs -f web    # View web app logs
#   docker-compose down           # Stop all services
#
# Access Points (via Nginx):
#   - User App:  http://localhost        (port 80)
#   - Admin:     http://localhost:8080   (port 8080)
#
# Direct Access (bypass Nginx):
#   - User App:  http://localhost:8501
#   - Admin:     http://localhost:8502
#
# For production, use: docker-compose -f docker-compose.prod.yml up -d

version: '3.8'

services:
  # ==========================================================================
  # Nginx Reverse Proxy
  # Entry point for all HTTP traffic with WebSocket support
  # ==========================================================================
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"      # Main app
      - "8080:8080"  # Admin dashboard
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web
      - admin
    networks:
      - fgn_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # Main user-facing bond subscription form
  # Access at: http://localhost (via Nginx) or http://localhost:8501 (direct)
  # ==========================================================================
  web:
    build:
      context: .
      args:
        PORT: 8501
    ports:
      - "8501:8501"
    env_file:
      - .env
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - fgn_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ==========================================================================
  # Admin dashboard (password protected)
  # Access at: http://localhost:8502
  # Default credentials: admin / admin123 (CHANGE FOR PRODUCTION!)
  # ==========================================================================
  admin:
    build:
      context: .
      args:
        PORT: 8502
    ports:
      - "8502:8502"
    env_file:
      - .env
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - fgn_network
    command: sh -c "streamlit run src/admin_app.py --server.port=8502 --server.address=0.0.0.0"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8502/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ==========================================================================
  # MongoDB database
  # Data persisted in mongodb_data volume
  # ==========================================================================
  mongodb:
    image: mongo:7.0  # Pinned version for reproducibility
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
    networks:
      - fgn_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

# ==========================================================================
# Networks
# ==========================================================================
networks:
  fgn_network:
    driver: bridge

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  mongodb_data:
    name: fgn_mongodb_data
